name: Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to rollback to (e.g. v0.1.15). Must be an existing tag.'
        required: true
        type: string

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  rollback:
    name: Rollback to ${{ inputs.version }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Validate tag format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format. Use vX.Y.Z (e.g. v0.1.15)"
            exit 1
          fi

      - name: Checkout at tag
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ inputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Verify version matches tag
        run: |
          TAG_VERSION="${{ inputs.version }}"
          TAG_VERSION="${TAG_VERSION#v}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch: package.json=$PKG_VERSION, tag=$TAG_VERSION"
            exit 1
          fi
          echo "Rolling back to version $PKG_VERSION"

      - name: Test CLI
        run: |
          chmod +x bin/doyaken lib/*.sh
          ./bin/doyaken --version

      - name: Roll back npm dist-tag to specified version
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          TAG_VERSION="${{ inputs.version }}"
          TAG_VERSION="${TAG_VERSION#v}"
          echo "Updating npm dist-tag 'latest' to point to ${PKG_NAME}@${TAG_VERSION}"
          npm dist-tag add "${PKG_NAME}@${TAG_VERSION}" latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Rollback summary
        run: |
          DEPLOYED_SHA=$(git rev-parse HEAD)
          echo "## Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Rolled back to** | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | $DEPLOYED_SHA |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | production (npm) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +'%Y-%m-%dT%H:%M:%SZ') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

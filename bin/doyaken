#!/usr/bin/env bash
#
# doyaken (dk) - Autonomous AI agent for software development
#
# This is the main entry point for the doyaken CLI.
# It sets up the environment and delegates to lib/cli.sh
#
set -euo pipefail

# Determine the installation directory from script location first,
# falling back to DOYAKEN_HOME env var only if local lib/ not found.
if [ -L "${BASH_SOURCE[0]}" ]; then
  # Symlinked binary - resolve to actual location
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  REAL_PATH="$(readlink "${BASH_SOURCE[0]}")"
  # Handle relative paths in symlink targets
  if [[ "$REAL_PATH" != /* ]]; then
    REAL_PATH="$SCRIPT_DIR/$REAL_PATH"
  fi
  INSTALL_DIR="$(cd "$(dirname "$REAL_PATH")/.." && pwd)"
else
  # Direct execution
  INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
fi

# Prefer the script's own lib/ directory (development/source), then
# fall back to DOYAKEN_HOME env var, then ~/.doyaken
if [ -d "$INSTALL_DIR/lib" ] && [ -f "$INSTALL_DIR/lib/cli.sh" ]; then
  # Running from source/package directory
  export DOYAKEN_HOME="$INSTALL_DIR"
elif [ -n "${DOYAKEN_HOME:-}" ] && [ -d "$DOYAKEN_HOME/lib" ]; then
  # Use env var
  export DOYAKEN_HOME="$DOYAKEN_HOME"
elif [ -d "$HOME/.doyaken/lib" ]; then
  # Use home directory installation
  export DOYAKEN_HOME="$HOME/.doyaken"
else
  # Fallback to script directory
  export DOYAKEN_HOME="$INSTALL_DIR"
fi

# Check for lib/cli.sh
CLI_SCRIPT="$DOYAKEN_HOME/lib/cli.sh"
if [ ! -f "$CLI_SCRIPT" ]; then
  echo "Error: cli.sh not found at $CLI_SCRIPT" >&2
  echo "DOYAKEN_HOME=$DOYAKEN_HOME" >&2
  echo "" >&2
  echo "Try reinstalling: npm install -g doyaken" >&2
  exit 1
fi

# Make sure scripts are executable
chmod +x "$CLI_SCRIPT" 2>/dev/null || true
chmod +x "$DOYAKEN_HOME/lib/core.sh" 2>/dev/null || true
chmod +x "$DOYAKEN_HOME/lib/taskboard.sh" 2>/dev/null || true

# Execute the CLI
exec "$CLI_SCRIPT" "$@"
